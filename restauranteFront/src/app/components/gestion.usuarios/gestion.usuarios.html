<div class="container">
  <div class="row align-items-center mb-3">
    <div class="col-sm-8">
      <div class="p-3 bg-light border rounded shadow-sm">
        <h4 class="mb-0">Gestión de Usuarios</h4>
        <p class="mb-0">Resumen de las operaciones del restaurante.</p>
      </div>
    </div>
    <div class="col-sm-4 text-sm-end text-center">
      <div class="p-3 bg-light border rounded shadow-sm">
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#nuevoUsuarioModal"
          (click)="abrirModalCrear()">
          ➕ Añadir Nuevo Usuario
        </button>
      </div>
    </div>
  </div>

  <div class="row text-center mb-3">
    <div class="col-sm-12 p-3 bg-light border rounded shadow-sm">
      <form class="d-flex mt-3" (ngSubmit)="buscarUsuarios()">
        <input 
          class="form-control me-2" 
          type="search" 
          placeholder="Buscar por nombre" 
          aria-label="Search"
          [(ngModel)]="terminoBusqueda"
          name="busqueda"/>
        <button class="btn btn-outline-success" type="submit">Buscar</button>
        <button 
          class="btn btn-outline-secondary ms-2" 
          type="button"
          (click)="terminoBusqueda = ''; cargarDatos()">
          Limpiar
        </button>
      </form>
    </div>
  </div>

  <div class="row text-center mb-3" *ngIf="error">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        {{ error }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="cargarDatos()">Reintentar</button>
      </div>
    </div>
  </div>

  <div class="row text-center mb-3">
    <div class="col-sm-12">
      <div class="p-3 bg-light border rounded shadow-sm">
        <div *ngIf="cargando" class="text-center py-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando usuarios...</p>
        </div>

        <table class="table" *ngIf="!cargando">
          <thead>
            <tr>
              <th scope="col">ID Usuario</th>
              <th scope="col">Nombre</th>
              <th scope="col">Email</th>
              <th scope="col">Fecha Registro</th>
              <th scope="col">Rol</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="usuarios.length === 0">
              <td colspan="6" class="text-center">No hay usuarios registrados.</td>
            </tr>
            <tr *ngFor="let u of usuarios">
              <th scope="row">{{ u.idUsuario }}</th>
              <td>{{ u.nombre }}</td>
              <td>{{ u.email }}</td>
              <td>{{ formatearFecha(u.fechaRegistro) }}</td>
              <td>{{ u.rol.nombre }}</td>
              <td>
                <button 
                  class="btn btn-sm btn-primary me-2"
                  data-bs-toggle="modal"
                  data-bs-target="#editarUsuarioModal"
                  (click)="abrirModalEditar(u)" 
                  title="Editar Usuario">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button 
                  class="btn btn-sm btn-danger me-2" 
                  data-bs-toggle="modal"
                  data-bs-target="#eliminarUsuarioModal"
                  (click)="abrirModalEliminar(u)" 
                  title="Eliminar Usuario">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Nuevo Usuario -->
<div
  class="modal fade"
  id="nuevoUsuarioModal"
  tabindex="-1"
  aria-labelledby="nuevoUsuarioModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nuevoUsuarioModalLabel">Nuevo Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form #usuarioForm="ngForm" (ngSubmit)="crearUsuario()">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input 
              type="text" 
              class="form-control" 
              name="nombre" 
              [(ngModel)]="nuevoUsuario.nombre"
              required>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo</label>
            <input 
              type="email" 
              class="form-control" 
              name="email" 
              [(ngModel)]="nuevoUsuario.email"
              required>
          </div>
          <div class="mb-3">
            <label class="form-label">Rol</label>
            <select 
              class="form-select" 
              name="rol" 
              [(ngModel)]="nuevoUsuario.rol.idRol"
              required>
              <option [ngValue]="0" disabled>Seleccione un rol</option>
              <option *ngFor="let r of roles" [ngValue]="r.idRol">
                {{ r.nombre }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Contraseña</label>
            <input 
              type="password" 
              class="form-control" 
              name="password" 
              [(ngModel)]="nuevoUsuario.password"
              required
              minlength="6">
            <small class="form-text text-muted">Mínimo 6 caracteres</small>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarUsuarioLabel">Editar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body" *ngIf="usuarioSeleccionado">
        <form #editarForm="ngForm" (ngSubmit)="actualizarUsuario()">
          <div class="mb-3">
            <label class="form-label">ID Usuario</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="usuarioSeleccionado.idUsuario" 
              name="idUsuario" 
              disabled>
            <small class="form-text text-muted">El ID no se puede modificar</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="usuarioSeleccionado.nombre" 
              name="nombre" 
              required>
          </div>

          <div class="mb-3">
            <label class="form-label">Correo</label>
            <input 
              type="email" 
              class="form-control" 
              [(ngModel)]="usuarioSeleccionado.email" 
              name="email" 
              required>
          </div>

          <div class="mb-3">
            <label class="form-label">Rol</label>
            <select 
              class="form-select" 
              [(ngModel)]="usuarioSeleccionado.rol" 
              [compareWith]="compararRoles" 
              name="rol"
              required>
              <option *ngFor="let r of roles" [ngValue]="r">
                {{ r.nombre }}
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Nueva Contraseña (opcional)</label>
            <input 
              type="password" 
              class="form-control" 
              [(ngModel)]="usuarioSeleccionado.password" 
              name="password"
              minlength="6"
              placeholder="Dejar vacío para mantener la actual">
            <small class="form-text text-muted">Dejar vacío para mantener la contraseña actual. Mínimo 6 caracteres si se cambia.</small>
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminar Usuario -->
<div class="modal fade" id="eliminarUsuarioModal" tabindex="-1" aria-labelledby="eliminarUsuarioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="usuarioEliminar">
        <p>¿Estás seguro de que deseas eliminar al usuario <strong>{{ usuarioEliminar.nombre }}</strong> ({{ usuarioEliminar.idUsuario }})?</p>
        <p class="text-danger"><small>Esta acción no se puede deshacer.</small></p>
      </div>
      <div class="modal-footer" *ngIf="usuarioEliminar">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="eliminarUsuario()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
