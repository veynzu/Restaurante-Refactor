<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-table"></i> Gestión de Mesas
    </h2>
    <button class="btn btn-primary" (click)="abrirModalNuevo()">
      <i class="bi bi-plus-circle"></i> Nueva Mesa
    </button>
  </div>

  <!-- Estadísticas -->
  <div class="row mb-4" *ngIf="!cargando">
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="text-muted mb-2">Total Mesas</h5>
          <h2 class="mb-0 text-primary">{{ estadisticas.total }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10">
        <div class="card-body text-center">
          <h5 class="text-muted mb-2">Disponibles</h5>
          <h2 class="mb-0 text-success">{{ estadisticas.disponibles }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100 bg-danger bg-opacity-10">
        <div class="card-body text-center">
          <h5 class="text-muted mb-2">Ocupadas</h5>
          <h2 class="mb-0 text-danger">{{ estadisticas.ocupadas }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10">
        <div class="card-body text-center">
          <h5 class="text-muted mb-2">Reservadas</h5>
          <h2 class="mb-0 text-warning">{{ estadisticas.reservadas }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Buscar por ubicación o ID</label>
          <input
            type="text"
            class="form-control"
            placeholder="Ej: Terraza A1, 5..."
            [(ngModel)]="terminoBusqueda"
            (input)="aplicarFiltros()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Filtrar por estado</label>
          <select
            class="form-select"
            [(ngModel)]="filtroEstado"
            (change)="aplicarFiltros()">
            <option [value]="null">Todos los estados</option>
            <option *ngFor="let estado of estadosMesas" [value]="estado.idEstado">
              {{ estado.nombre }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Capacidad mínima</label>
          <input
            type="number"
            class="form-control"
            placeholder="Ej: 4"
            min="1"
            [(ngModel)]="capacidadMinima"
            (input)="aplicarFiltros()">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()">
            <i class="bi bi-x-circle"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando mesas...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Grid de Mesas -->
  <div *ngIf="!cargando && !error" class="row g-4">
    <div
      *ngFor="let mesa of mesasFiltradas"
      class="col-md-6 col-lg-4 col-xl-3">
      <div class="card mesa-card h-100 shadow-sm border-0" 
           [ngClass]="'border-' + obtenerColorEstado(mesa.estado?.nombre)">
        <div class="card-body">
          <!-- Header de la tarjeta -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="card-title mb-0">
                <span class="badge bg-secondary me-2">#{{ mesa.idMesa }}</span>
                {{ mesa.ubicacion }}
              </h5>
            </div>
            <span class="badge" 
                  [ngClass]="'bg-' + obtenerColorEstado(mesa.estado?.nombre)">
              {{ obtenerIconoEstado(mesa.estado?.nombre) }} 
              {{ mesa.estado?.nombre || 'Sin estado' }}
            </span>
          </div>

          <!-- Información de la mesa -->
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-people-fill text-primary me-2"></i>
              <span><strong>Capacidad:</strong> {{ mesa.capacidad }} personas</span>
            </div>
          </div>

          <!-- Acciones rápidas -->
          <div class="btn-group w-100" role="group">
            <button
              *ngIf="!esEstado(mesa, 'ocupado')"
              class="btn btn-sm btn-danger"
              (click)="ocuparMesa(mesa)"
              title="Ocupar mesa">
              <i class="bi bi-circle-fill"></i> Ocupar
            </button>
            <button
              *ngIf="!esEstado(mesa, 'disponible')"
              class="btn btn-sm btn-success"
              (click)="liberarMesa(mesa)"
              title="Liberar mesa">
              <i class="bi bi-check-circle"></i> Liberar
            </button>
            <button
              *ngIf="!esEstado(mesa, 'reservado')"
              class="btn btn-sm btn-warning"
              (click)="reservarMesa(mesa)"
              title="Reservar mesa">
              <i class="bi bi-bookmark"></i> Reservar
            </button>
          </div>

          <!-- Acciones de edición -->
          <div class="mt-2 d-flex gap-2">
            <button
              class="btn btn-sm btn-outline-info flex-fill"
              (click)="verComandasMesa(mesa)"
              title="Ver comandas y facturación">
              <i class="bi bi-receipt"></i> Comandas
            </button>
            <button
              class="btn btn-sm btn-outline-primary flex-fill"
              (click)="abrirModalEditar(mesa)">
              <i class="bi bi-pencil"></i> Editar
            </button>
            <button
              class="btn btn-sm btn-outline-danger flex-fill"
              (click)="abrirModalEliminar(mesa)">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje cuando no hay mesas -->
    <div *ngIf="mesasFiltradas.length === 0" class="col-12">
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle"></i> No se encontraron mesas con los filtros aplicados.
      </div>
    </div>
  </div>
</div>

<!-- Modal Nuevo Mesa -->
<div class="modal fade" id="nuevoMesaModal" tabindex="-1" aria-labelledby="nuevoMesaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nuevoMesaModalLabel">Nueva Mesa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form #mesaForm="ngForm" (ngSubmit)="crearMesa()">
          <div class="mb-3">
            <label class="form-label">Ubicación</label>
            <input
              type="text"
              class="form-control"
              name="ubicacion"
              [(ngModel)]="nuevoMesa.ubicacion"
              placeholder="Ej: Terraza A1, Interior B2..."
              required>
            <small class="form-text text-muted">Describe la ubicación de la mesa</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Capacidad</label>
            <input
              type="number"
              class="form-control"
              name="capacidad"
              [(ngModel)]="nuevoMesa.capacidad"
              min="1"
              required>
            <small class="form-text text-muted">Número de personas que puede acomodar</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Estado Inicial</label>
            <select
              class="form-select"
              name="estado"
              [(ngModel)]="nuevoMesa.estado.idEstado"
              (change)="cambiarEstadoNuevoMesa($any($event.target).value)"
              required>
              <option [value]="0" disabled>Seleccione un estado</option>
              <option *ngFor="let estado of estadosMesas" [value]="estado.idEstado">
                {{ estado.nombre }}
              </option>
            </select>
            <small class="form-text text-muted">Solo se muestran estados válidos para mesas</small>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Mesa -->
<div class="modal fade" id="editarMesaModal" tabindex="-1" aria-labelledby="editarMesaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarMesaModalLabel">Editar Mesa #{{ mesaSeleccionada?.idMesa }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" *ngIf="mesaSeleccionada">
        <form #mesaEditForm="ngForm" (ngSubmit)="actualizarMesa()">
          <div class="mb-3">
            <label class="form-label">Ubicación</label>
            <input
              type="text"
              class="form-control"
              name="ubicacion"
              [(ngModel)]="mesaSeleccionada.ubicacion"
              required>
          </div>
          <div class="mb-3">
            <label class="form-label">Capacidad</label>
            <input
              type="number"
              class="form-control"
              name="capacidad"
              [(ngModel)]="mesaSeleccionada.capacidad"
              min="1"
              required>
          </div>
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select
              class="form-select"
              name="estado"
              [ngModel]="mesaSeleccionada.estado?.idEstado"
              (ngModelChange)="cambiarEstadoMesaSeleccionada($event)"
              required>
              <option *ngFor="let estado of estadosMesas" [value]="estado.idEstado">
                {{ estado.nombre }}
              </option>
            </select>
            <small class="form-text text-muted">Solo se muestran estados válidos para mesas</small>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminar Mesa -->
<div class="modal fade" id="eliminarMesaModal" tabindex="-1" aria-labelledby="eliminarMesaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="eliminarMesaModalLabel">Eliminar Mesa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" *ngIf="mesaEliminar">
        <p>¿Estás seguro de que deseas eliminar la mesa <strong>#{{ mesaEliminar.idMesa }}</strong> ubicada en <strong>{{ mesaEliminar.ubicacion }}</strong>?</p>
        <p class="text-danger"><small>Esta acción no se puede deshacer.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="eliminarMesa()">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Comandas y Facturación -->
<div class="modal fade" id="comandasMesaModal" tabindex="-1" aria-labelledby="comandasMesaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="comandasMesaModalLabel">
          <i class="bi bi-receipt me-2"></i>
          Comandas - Mesa {{ mesaSeleccionada?.idMesa }} ({{ mesaSeleccionada?.ubicacion }})
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Loading -->
        <div *ngIf="cargandoFacturacion" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3 text-muted">Cargando comandas...</p>
        </div>

        <!-- Contenido de facturación -->
        <div *ngIf="!cargandoFacturacion && facturacionMesa">
          <!-- Mensaje si la mesa está disponible -->
          <div *ngIf="mesaSeleccionada?.estado?.nombre?.toLowerCase() === 'disponible'" 
               class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Mesa Disponible:</strong> Esta mesa está actualmente libre. 
            Las comandas mostradas son del historial. Para crear nuevas comandas, primero ocupa la mesa.
          </div>

          <!-- Resumen -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">Total Comandas</h6>
                  <h3 class="mb-0 text-primary">{{ facturacionMesa.totalComandas }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">Completadas</h6>
                  <h3 class="mb-0 text-success">{{ facturacionMesa.comandasCompletadas }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">Pendientes</h6>
                  <h3 class="mb-0 text-warning">{{ facturacionMesa.comandasPendientes }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">Pagadas</h6>
                  <h3 class="mb-0 text-info">{{ facturacionMesa.comandasPagadas || 0 }}</h3>
                </div>
              </div>
            </div>
          </div>

          <!-- Total a pagar -->
          <div *ngIf="facturacionMesa.todasCompletadas && facturacionMesa.totalAPagar > 0 && !facturacionMesa.todasPagadas" 
               class="alert alert-success d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">
                <i class="bi bi-check-circle me-2"></i>
                Todas las comandas están completadas
              </h5>
              <p class="mb-0">Puede generar la factura y marcar como pagadas</p>
            </div>
            <div class="text-end">
              <h4 class="mb-0">{{ formatearMoneda(facturacionMesa.totalAPagar) }}</h4>
              <small class="text-muted">Total a pagar</small>
            </div>
          </div>

          <!-- Todas pagadas -->
          <div *ngIf="facturacionMesa.todasPagadas" 
               class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">
                <i class="bi bi-currency-dollar me-2"></i>
                Todas las comandas están pagadas
              </h5>
              <p class="mb-0">La mesa puede ser liberada</p>
            </div>
            <div class="text-end">
              <h4 class="mb-0 text-muted">{{ formatearMoneda(0) }}</h4>
              <small class="text-muted">Total pendiente</small>
            </div>
          </div>

          <!-- Advertencia si hay comandas pendientes -->
          <div *ngIf="!facturacionMesa.todasCompletadas" 
               class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Hay {{ facturacionMesa.comandasPendientes }} comanda(s) pendiente(s) o en preparación. 
            Complete todas las comandas para generar la factura.
          </div>

          <!-- Lista de comandas -->
          <h6 class="mb-3">
            <i class="bi bi-list-ul me-2"></i>
            <span *ngIf="mesaSeleccionada?.estado?.nombre?.toLowerCase() === 'disponible'">Historial de Comandas</span>
            <span *ngIf="mesaSeleccionada?.estado?.nombre?.toLowerCase() !== 'disponible'">Detalle de Comandas</span>
          </h6>
          <div *ngIf="facturacionMesa.comandas.length === 0" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <span *ngIf="mesaSeleccionada?.estado?.nombre?.toLowerCase() === 'disponible'">
              Esta mesa está disponible y no tiene comandas activas.
            </span>
            <span *ngIf="mesaSeleccionada?.estado?.nombre?.toLowerCase() !== 'disponible'">
              Esta mesa no tiene comandas registradas.
            </span>
          </div>
          <div *ngIf="facturacionMesa.comandas.length > 0" class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Fecha</th>
                  <th>Estado</th>
                  <th>Mesero</th>
                  <th>Productos</th>
                  <th class="text-end">Total</th>
                  <th>Pago</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let comanda of facturacionMesa.comandas" 
                    [ngClass]="{'table-secondary': comanda.pagada}">
                  <td><strong>#{{ comanda.idComanda }}</strong></td>
                  <td>{{ formatearFecha(comanda.fecha) }}</td>
                  <td>
                    <span class="badge" 
                          [ngClass]="{
                            'bg-success': comanda.estado === 'Completado' || comanda.estado === 'Completada',
                            'bg-warning': comanda.estado === 'Pendiente' || comanda.estado === 'En Preparacion',
                            'bg-danger': comanda.estado === 'Cancelado' || comanda.estado === 'Cancelada'
                          }">
                      {{ comanda.estado }}
                    </span>
                  </td>
                  <td>{{ comanda.mesero }}</td>
                  <td>{{ comanda.cantidadProductos }} producto(s)</td>
                  <td class="text-end">
                    <strong [ngClass]="{'text-decoration-line-through text-muted': comanda.pagada}">
                      {{ formatearMoneda(comanda.total) }}
                    </strong>
                  </td>
                  <td>
                    <span *ngIf="comanda.pagada" class="badge bg-success">
                      <i class="bi bi-check-circle me-1"></i>Pagada
                    </span>
                    <span *ngIf="!comanda.pagada && (comanda.estado === 'Completado' || comanda.estado === 'Completada')" 
                          class="badge bg-warning">
                      <i class="bi bi-clock me-1"></i>Pendiente
                    </span>
                    <span *ngIf="!comanda.pagada && comanda.estado !== 'Completado' && comanda.estado !== 'Completada'" 
                          class="text-muted">
                      -
                    </span>
                  </td>
                  <td>
                    <button *ngIf="!comanda.pagada && (comanda.estado === 'Completado' || comanda.estado === 'Completada')"
                            class="btn btn-sm btn-success"
                            (click)="marcarComandaComoPagada(comanda.idComanda)"
                            title="Marcar como pagada">
                      <i class="bi bi-currency-dollar"></i>
                    </button>
                    <span *ngIf="comanda.pagada" class="text-muted">
                      <i class="bi bi-check-circle text-success"></i>
                    </span>
                  </td>
                </tr>
              </tbody>
              <tfoot *ngIf="facturacionMesa.todasCompletadas">
                <tr class="table-primary">
                  <td colspan="6" class="text-end"><strong>TOTAL A PAGAR:</strong></td>
                  <td class="text-end" colspan="2">
                    <strong class="fs-5">{{ formatearMoneda(facturacionMesa.totalAPagar) }}</strong>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button 
          *ngIf="facturacionMesa && facturacionMesa.todasCompletadas && facturacionMesa.totalAPagar > 0 && !facturacionMesa.todasPagadas"
          type="button" 
          class="btn btn-success"
          (click)="imprimirFactura()">
          <i class="bi bi-printer me-2"></i>
          Imprimir Factura
        </button>
        <button 
          *ngIf="facturacionMesa && facturacionMesa.todasCompletadas && facturacionMesa.totalAPagar > 0 && !facturacionMesa.todasPagadas"
          type="button" 
          class="btn btn-primary"
          (click)="marcarTodasComandasPagadas()">
          <i class="bi bi-currency-dollar me-2"></i>
          Marcar Todas como Pagadas
        </button>
        <button 
          *ngIf="facturacionMesa && facturacionMesa.comandasPendientes > 0"
          type="button" 
          class="btn btn-primary"
          (click)="finalizarYLiberarMesa()">
          <i class="bi bi-check-circle me-2"></i>
          Finalizar Comandas y Liberar Mesa
        </button>
        <button 
          *ngIf="facturacionMesa && facturacionMesa.todasCompletadas && facturacionMesa.totalAPagar > 0 && mesaSeleccionada?.estado?.nombre?.toLowerCase() !== 'disponible'"
          type="button" 
          class="btn btn-warning"
          (click)="finalizarYLiberarMesa()">
          <i class="bi bi-door-open me-2"></i>
          Liberar Mesa
        </button>
      </div>
    </div>
  </div>
</div>
